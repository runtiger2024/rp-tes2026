// backend/prisma/schema.prisma
// V18.1 - 旗艦級專業物流 ERP 終極整合版
// 整合重點：Express 5 兼容、Prisma 6 引擎、家具代購模組、細緻化報關、財務流水審計、CMS 內容管理

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // 建議使用 PostgreSQL 以支援高度併發
  url      = env("DATABASE_URL")
}

// ==========================================
// --- 1. 使用者與權限管理 ---
// ==========================================
model User {
  id                  String   @id @default(cuid())
  piggyId             String?  @unique // RP00001 格式
  email               String   @unique
  passwordHash        String?
  name                String?
  phone               String?
  defaultAddress      String?
  lineUserId          String?  @unique
  role                Role     @default(USER) // USER, ADMIN, WAREHOUSE, FINANCE

  // 發票預設資料 (整合自 V17)
  defaultTaxId         String?
  defaultInvoiceTitle String?

  // 會員等級 (與 Tier 關聯)
  tierId              String?
  tier                Tier?    @relation(fields: [tierId], references: [id])

  // 財務與點數總覽 (核心餘額系統)
  balance             Float    @default(0)
  points              Int      @default(0)

  // 帳號狀態
  isActive            Boolean  @default(true)
  resetPasswordToken  String?
  resetPasswordExpire DateTime?

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // 關聯模組
  packages            Package[]
  shipments           Shipment[]
  transactions        WalletTransaction[]
  pointLogs           PointLog[]
  coupons             UserCoupon[]
  declarants          Declarant[]
  recipients          Recipient[]      // 常用收件人地址簿
  furnitureOrders      FurnitureOrder[] // 家具代採購
  activityLogs        ActivityLog[]
  notifications       Notification[]

  @@index([piggyId])
  @@index([lineUserId])
}

enum Role {
  USER
  ADMIN
  WAREHOUSE
  FINANCE
}

// ==========================================
// --- 2. 會員等級與折扣系統 ---
// ==========================================
model Tier {
  id                String   @id @default(cuid())
  name              String   @unique // 如：普通會員, 黃金會員, 鑽石會員
  level             Int      @default(0)
  thresholdAmount   Float    @default(0)   // 升級所需的累計消費額
  discountRate      Float    @default(1.0) // 運費折扣，例如 0.95 代表 95 折
  pointMultiplier   Float    @default(1.0) // 點數回饋倍率
  priority          Int      @default(0)   // 處理優先順序
  users             User[]
}

// ==========================================
// --- 3. 倉儲與包裹預報系統 (整合 V17 精細欄位) ---
// ==========================================
model Package {
  id                String        @id @default(cuid())
  trackingNumber    String        @unique // 快遞單號
  userId            String
  user              User          @relation(fields: [userId], references: [id])
  
  // 包裹資訊 (報關精細欄位)
  itemName          String?       // 物品名稱
  category          String?       // 物品類別
  quantity          Int           @default(1)
  declaredValue     Float         @default(0) // 申報價值
  productUrl        String?       @db.Text    // 商品連結 (V17 需求)
  modelNumber       String?       // 型號 (V17 需求)
  spec              String?       // 規格 (V17 需求)
  
  // 入庫重量與材積 (由倉庫測量)
  weight            Float?        // 實際重量 (kg)
  length            Float?        // 長 (cm)
  width             Float?        // 寬 (cm)
  height            Float?        // 高 (cm)
  volumetricWeight  Float?        // 材積重
  
  // 倉儲資訊
  warehouseLocation String?       // 倉庫儲位
  warehouseNote     String?       @db.Text
  productImages     Json          @default("[]") // 客戶預報圖片
  warehousePhotos   String[]      // 倉庫實拍圖片 URL 陣列

  // 狀態
  status            PackageStatus @default(PENDING)
  
  // 關聯集運單
  shipmentId        String?
  shipment          Shipment?     @relation(fields: [shipmentId], references: [id])

  arrivedAt         DateTime?     // 入庫時間
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([userId])
  @@index([status])
}

enum PackageStatus {
  PENDING        // 預報中
  IN_WAREHOUSE   // 已入庫
  PROCESSING     // 打包中 (已申請集運)
  SHIPPED        // 已出庫
  ARRIVED        // 已簽收
  LOST           // 遺失
  RETURNED       // 已退貨
}

// ==========================================
// --- 4. 集運單與物流引擎 (整合 V17 財務/發票欄位) ---
// ==========================================
model Shipment {
  id                String         @id @default(cuid())
  shipmentNo        String         @unique // SPG... 或 MEM...
  userId            String
  user              User           @relation(fields: [userId], references: [id])
  
  // 收件資訊與報關
  recipientName     String
  recipientPhone    String
  recipientAddress  String
  declarantId       String?        // 關聯報關人
  declarant         Declarant?     @relation(fields: [declarantId], references: [id])
  idCardNumber      String?        // 實名認證身分證字號
  
  // 財務與發票 (V17 核心功能)
  taxId             String?
  invoiceTitle      String?
  invoiceNumber     String?
  invoiceDate       DateTime?
  invoiceRandomCode String?
  invoiceStatus     String?        @default("PENDING")

  // 管理員備註 (V17 用於改價或審核紀錄)
  adminNote         String?        @db.Text
  
  // 物流計算結果快照
  totalWeight       Float          @default(0)
  chargeableWeight  Float          @default(0)
  shippingFee       Float          @default(0)
  serviceFee        Float          @default(0) // 額外服務費 (加固, 拍照等)
  insuranceFee      Float          @default(0)
  couponDiscount    Float          @default(0)
  pointsDiscount    Float          @default(0)
  finalAmount       Float          @default(0) // 最終實付金額

  // 物流狀態
  status            ShipmentStatus @default(UNPAID)
  localCarrier      String?        // 台灣在地物流 (黑貓, 專車)
  localTrackingNo   String?        // 台灣派送單號

  // 支付紀錄
  paidAt            DateTime?
  paymentMethod     String?        // WALLET, CREDIT_CARD, POINT_ONLY
  paymentProof      String?        // 支付憑證圖片網址 (V17 需求)

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  packages          Package[]
  serviceItems      ShipmentServiceDetail[] // 勾選的附加服務清單

  @@index([userId])
  @@index([status])
}

enum ShipmentStatus {
  UNPAID         // 待支付
  PAID           // 已支付 (待處理)
  PROCESSING     // 揀貨打包中
  READY_TO_SHIP  // 待出庫 (清關中)
  SHIPPED        // 運輸中
  ARRIVED        // 已送達
  CANCELLED      // 已取消
}

// ==========================================
// --- 5. 報關與地址簿 (整合常用收件人) ---
// ==========================================
model Declarant {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  name         String
  phone        String
  idCardNumber String
  isDefault    Boolean    @default(false)
  shipments    Shipment[]
  createdAt    DateTime   @default(now())
}

model Recipient {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  phone       String
  address     String
  idNumber    String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

// ==========================================
// --- 6. 財務交易與錢包流水 (V18 強化版) ---
// ==========================================
model WalletTransaction {
  id            String          @id @default(cuid())
  userId        String
  user          User            @relation(fields: [userId], references: [id])
  amount        Float
  type          TransactionType
  status        TxStatus        @default(COMPLETED)
  description   String?
  referenceId   String?         // 關聯的運單號、充值單號或家具訂單號
  proofImage    String?         // 支付憑證圖片 (V17 線下轉帳需求)
  balanceBefore Float
  balanceAfter  Float
  createdAt     DateTime        @default(now())

  @@index([userId])
}

enum TransactionType {
  RECHARGE      // 儲值
  PAYMENT       // 支付運費
  FURNITURE_PAY // 家具支付
  REFUND        // 退款
  ADJUSTMENT    // 手動調帳
}

enum TxStatus {
  PENDING
  COMPLETED
  FAILED
  REJECTED
}

// ==========================================
// --- 7. 家具代採購系統 (整合自 V17 旗艦版) ---
// ==========================================
model FurnitureOrder {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  factoryName     String
  productName     String
  productUrl      String?  @db.Text
  quantity        Int
  priceRMB        Float
  
  serviceFeeRMB   Float    
  exchangeRate    Float    
  serviceFeeRate  Float    
  totalAmountTWD  Int      
  
  status          String   @default("PENDING") // PENDING, PAID, ORDERED, ARRIVED, COMPLETED
  note            String?  @db.Text
  adminRemark     String?  @db.Text
  refImageUrl     String?  @db.Text
  invoiceUrl      String?  @db.Text 

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

// ==========================================
// --- 8. 點數與行銷系統 ---
// ==========================================
model PointLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  points      Int      // 正值為獲得，負值為抵扣
  reason      String   // 如：曬圖獎勵, 運費抵扣
  createdAt   DateTime @default(now())
}

model UserCoupon {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  code      String
  discount  Float
  isUsed    Boolean  @default(false)
  usedAt    DateTime?
  expireAt  DateTime
  createdAt DateTime @default(now())
}

// ==========================================
// --- 9. 系統配置與附加服務 ---
// ==========================================
model SystemSetting {
  id           String   @id @default(cuid())
  key          String   @unique // 如: EXCHANGE_RATE, FURNITURE_CONFIG
  value        Json     // 改為 Json 以支援 V17 的複雜配置
  category     String?
  description  String?
  updatedAt    DateTime @updatedAt
}

model ShipmentServiceItem {
  id          String   @id @default(cuid())
  name        String   // 服務名稱 (如: 釘木架, 加強打包)
  price       Float    @default(0)
  unit        String   @default("PIECE") // PIECE, WEIGHT, SHIPMENT
  isActive    Boolean  @default(true)
  details     ShipmentServiceDetail[]
}

model ShipmentServiceDetail {
  id                String              @id @default(cuid())
  shipmentId       String
  shipment         Shipment            @relation(fields: [shipmentId], references: [id])
  serviceItemId    String
  serviceItem      ShipmentServiceItem @relation(fields: [serviceItemId], references: [id])
  feeCharged       Float
}

// ==========================================
// --- 10. CMS 內容管理 (FAQ、消息、靜態內容) ---
// ==========================================
model News {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  category    String   @default("GENERAL") // SYSTEM, PROMOTION, HOLIDAY
  isImportant Boolean  @default(false)
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model FAQ {
  id        String   @id @default(cuid())
  question  String
  answer    String   @db.Text
  category  String?  // LOGISTICS, PAYMENT, CUSTOMS, ACCOUNT
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  updatedAt DateTime @updatedAt
}

model StaticContent {
  id        String   @id @default(cuid())
  key       String   @unique // 如：ABOUT_US, TERMS_OF_SERVICE
  title     String
  content   String   @db.Text
  isActive  Boolean  @default(true)
  updatedAt DateTime @updatedAt
}

// ==========================================
// --- 11. 基礎設施 (日誌與通知) ---
// ==========================================
model ActivityLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String   // 操作動作
  target    String?  // 操作目標 (如: Package:ID)
  ip        String?
  details   Json?
  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  content   String   @db.Text
  isRead    Boolean  @default(false)
  type      String   @default("SYSTEM") // SYSTEM, SHIPMENT, WALLET
  link      String?  // 跳轉連結
  createdAt DateTime @default(now())
}