<div id="claim-package-modal" class="modal-overlay" style="display: none">
  <div class="modal-content animate-pop-in">
    <button class="modal-close" onclick="window.modalManager.close()">
      &times;
    </button>

    <div class="modal-header">
      <h3 style="margin: 0; color: #1e293b; font-weight: 800">
        <i
          class="fas fa-hand-holding-box"
          style="color: #1a73e8; margin-right: 10px"
        ></i
        >認領無主包裹
      </h3>
    </div>

    <div class="modal-body">
      <div
        class="alert alert-info"
        style="
          background: #f0f9ff;
          color: #0369a1;
          padding: 12px;
          border-radius: 10px;
          font-size: 13px;
          line-height: 1.6;
          margin-bottom: 20px;
          border: 1px solid #e0f2fe;
        "
      >
        <i class="fas fa-info-circle"></i>
        若您忘記預報且包裹已入庫（顯示為無主件），請在此認領。<br />
        <strong>只需輸入完整單號即可認領</strong>，購物憑證為選填。
      </div>

      <form id="claim-package-form">
        <div class="form-group" style="margin-bottom: 15px">
          <label
            class="required"
            style="
              display: block;
              margin-bottom: 8px;
              font-weight: 600;
              color: #334155;
            "
            >物流單號</label
          >
          <input
            type="text"
            id="claim-tracking"
            class="form-control"
            placeholder="請輸入完整物流單號"
            required
            style="
              width: 100%;
              padding: 12px;
              border: 1.5px solid #e2e8f0;
              border-radius: 10px;
              font-size: 15px;
            "
          />
        </div>

        <div class="form-group">
          <label
            style="
              display: block;
              margin-bottom: 8px;
              font-weight: 600;
              color: #334155;
            "
            >購物證明截圖 (選填)</label
          >
          <div
            class="upload-zone-wrapper"
            style="position: relative; height: 180px"
          >
            <label
              for="claim-proof"
              class="upload-zone"
              style="
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
                border: 2px dashed #cbd5e1;
                border-radius: 12px;
                cursor: pointer;
                background: #f8fafc;
                transition: all 0.2s;
                position: relative;
                overflow: hidden;
              "
            >
              <i
                class="fas fa-camera"
                style="font-size: 32px; color: #94a3b8; margin-bottom: 10px"
              ></i>
              <span style="color: #64748b; font-size: 14px"
                >點擊上傳購物證明</span
              >

              <img
                id="claim-proof-preview"
                src=""
                style="
                  display: none;
                  position: absolute;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  object-fit: contain;
                  background: #fff;
                  z-index: 5;
                "
              />
            </label>
            <input
              type="file"
              id="claim-proof"
              accept="image/*"
              style="display: none"
            />
          </div>
          <p style="font-size: 11px; color: #94a3b8; margin-top: 8px">
            * 上傳截圖可加速管理員審核歸屬權的速度。
          </p>
        </div>

        <div
          class="modal-footer"
          style="margin-top: 25px; display: flex; gap: 10px"
        >
          <button
            type="button"
            class="btn btn-secondary"
            onclick="window.modalManager.close()"
            style="
              flex: 1;
              padding: 12px;
              border-radius: 10px;
              font-weight: 600;
            "
          >
            取消
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            style="
              flex: 2;
              padding: 12px;
              border-radius: 10px;
              font-weight: 600;
              background: #1a73e8;
              color: #fff;
              border: none;
            "
          >
            確認提交認領
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  /**
   * 深度還原：原始圖片預覽腳本
   * 確保選取檔案後能立刻看到預覽圖
   */
  document
    .getElementById("claim-proof")
    .addEventListener("change", function (e) {
      const file = e.target.files[0];
      const preview = document.getElementById("claim-proof-preview");

      if (file) {
        const reader = new FileReader();
        reader.onload = function (event) {
          preview.src = event.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });

  /**
   * 深度還原：表單提交邏輯
   * 對接核心 parcel.js 模組的 claimUnclaimedPackage 方法
   */
  document
    .getElementById("claim-package-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();
      const tracking = document.getElementById("claim-tracking").value.trim();
      const file = document.getElementById("claim-proof").files[0];

      // 這裡會由外部加載的 parcel.js 處理具體 API 調用
      if (window.parcelModule && window.parcelModule.claimUnclaimedPackage) {
        await window.parcelModule.claimUnclaimedPackage(tracking, file);
      } else {
        console.error("Parcel module not loaded");
      }
    });
</script>
