<div
  class="modal-content card animate-pop-in"
  style="
    width: 1050px;
    max-width: 98%;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  "
>
  <div
    class="card-header d-flex justify-content-between align-items-center sticky-top bg-white"
    style="padding: 20px 25px; border-bottom: 2px solid #f1f5f9; z-index: 10"
  >
    <h3
      style="
        margin: 0;
        font-weight: 800;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 12px;
      "
    >
      <i class="fas fa-tools" style="color: #1a73e8"></i> 訂單管理與維護
    </h3>
    <button
      type="button"
      class="modal-close"
      onclick="window.modalManager.close()"
      style="
        font-size: 24px;
        border: none;
        background: transparent;
        cursor: pointer;
        color: #94a3b8;
      "
    >
      &times;
    </button>
  </div>

  <div class="card-body" style="padding: 25px; background: #fcfdfe">
    <form id="edit-shipment-form">
      <input type="hidden" id="edit-shipment-id" />

      <div
        class="row mb-4"
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          background: #fff;
          padding: 15px;
          border-radius: 12px;
          border: 1px solid #e2e8f0;
        "
      >
        <div>
          <strong
            style="
              color: #64748b;
              font-size: 12px;
              display: block;
              text-transform: uppercase;
            "
            >收件人</strong
          >
          <span
            id="m-recipient"
            style="font-weight: 800; color: #1e293b"
          ></span>
        </div>
        <div>
          <strong
            style="
              color: #64748b;
              font-size: 12px;
              display: block;
              text-transform: uppercase;
            "
            >聯繫電話</strong
          >
          <span id="m-phone" style="font-weight: 800; color: #1e293b"></span>
        </div>
        <div>
          <strong
            style="
              color: #64748b;
              font-size: 12px;
              display: block;
              text-transform: uppercase;
            "
            >會員 ID</strong
          >
          <div style="display: flex; align-items: center; gap: 5px">
            <span id="m-user" style="font-weight: 800; color: #1a73e8"></span>
            <small
              id="m-piggy-id"
              style="color: #94a3b8; font-family: monospace"
            ></small>
          </div>
        </div>
      </div>

      <div class="mb-4">
        <label
          class="font-weight-bold text-dark"
          style="display: block; margin-bottom: 12px; font-weight: 800"
        >
          <i class="fas fa-cubes" style="color: #64748b"></i> 包含包裹詳細清單
          (Package List)
        </label>
        <div
          class="package-list-box border rounded bg-light"
          style="
            max-height: 300px;
            overflow-y: auto;
            border-radius: 12px;
            border: 1.5px solid #e2e8f0;
          "
        >
          <table
            class="package-detail-table"
            style="width: 100%; border-collapse: collapse"
          >
            <thead
              class="bg-secondary text-white"
              style="
                background: #475569;
                color: white;
                position: sticky;
                top: 0;
              "
            >
              <tr>
                <th style="width: 70px; padding: 12px">照片</th>
                <th style="padding: 12px; text-align: left">單號/品名</th>
                <th style="width: 110px; padding: 12px; text-align: left">
                  分類
                </th>
                <th style="padding: 12px; text-align: left">
                  規格 (長*寬*高/重)
                </th>
                <th style="padding: 12px; text-align: right">預估費用</th>
              </tr>
            </thead>
            <tbody id="m-packages-list-body" style="background: white"></tbody>
          </table>
        </div>
      </div>

      <div
        id="audit-action-section"
        class="audit-section mb-4"
        style="
          display: none;
          background: #fff9db;
          border: 2px dashed #fab005;
          padding: 20px;
          border-radius: 12px;
        "
      >
        <h6
          style="
            font-weight: 900;
            color: #856404;
            margin-top: 0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
          "
        >
          <i class="fas fa-gavel"></i> 管理員審核與最終核價 (Final Pricing)
        </h6>
        <div
          class="row"
          style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px"
        >
          <div class="col-md-4">
            <label style="font-size: 13px; font-weight: 700"
              >最終核定金額 (NT$)</label
            >
            <input
              type="number"
              id="m-audit-cost"
              class="form-control"
              style="
                border: 2px solid #fab005;
                border-radius: 10px;
                font-weight: 800;
                font-size: 1.1rem;
                color: #d32f2f;
              "
              placeholder="填寫最終運費"
            />
          </div>
          <div class="col-md-8">
            <label style="font-size: 13px; font-weight: 700"
              >管理員備註 (對外顯示)</label
            >
            <input
              type="text"
              id="m-audit-note"
              class="form-control"
              style="border: 1px solid #fab005; border-radius: 10px"
              placeholder="例如：超材費用調整或特別加收..."
            />
          </div>
        </div>
        <div
          class="text-right mt-3"
          style="text-align: right; margin-top: 15px"
        >
          <button
            type="button"
            class="btn btn-warning"
            onclick="window.approveShipment()"
            style="
              background: #fab005;
              color: #1e293b;
              border: none;
              padding: 10px 25px;
              border-radius: 10px;
              font-weight: 800;
              cursor: pointer;
              box-shadow: 0 4px 10px rgba(250, 176, 5, 0.3);
            "
          >
            <i class="fas fa-check-circle"></i> 通過審核並更新狀態
          </button>
        </div>
      </div>

      <div
        class="row mb-4"
        style="display: grid; grid-template-columns: 1.2fr 1fr; gap: 20px"
      >
        <div class="col-md-6">
          <div
            class="border p-3 rounded"
            style="
              background: #fff;
              border: 1px solid #e2e8f0;
              border-radius: 12px;
              padding: 15px;
            "
          >
            <label
              class="font-weight-bold text-primary"
              style="
                font-weight: 800;
                color: #1a73e8;
                margin-bottom: 12px;
                display: block;
              "
            >
              <i class="fas fa-file-invoice"></i> 發票抬頭資訊 (B2B)
            </label>
            <div
              class="row"
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px"
            >
              <div>
                <small style="color: #64748b; font-weight: 700">統一編號</small>
                <input
                  type="text"
                  id="m-tax-id"
                  class="form-control"
                  style="border-radius: 8px"
                />
              </div>
              <div>
                <small style="color: #64748b; font-weight: 700">抬頭名稱</small>
                <input
                  type="text"
                  id="m-invoice-title"
                  class="form-control"
                  style="border-radius: 8px"
                />
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div
            class="border p-3 rounded text-center"
            style="
              background: #fff;
              border: 1px solid #e2e8f0;
              border-radius: 12px;
              padding: 15px;
              display: flex;
              flex-direction: column;
              align-items: center;
            "
          >
            <label
              class="font-weight-bold text-info"
              style="
                font-weight: 800;
                color: #0891b2;
                margin-bottom: 8px;
                display: block;
              "
            >
              <i class="fas fa-receipt"></i> 用戶支付憑證快照
            </label>
            <div
              id="m-proof"
              class="bg-white border rounded mt-1"
              style="
                width: 100%;
                min-height: 80px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 1px dashed #cbd5e1;
                border-radius: 8px;
                overflow: hidden;
              "
            >
              <span style="color: #94a3b8; font-size: 13px">載入憑證中...</span>
            </div>
          </div>
        </div>
      </div>

      <div
        class="bg-light p-4 rounded border mb-4"
        style="
          background: #f8fafc;
          border: 1px solid #e2e8f0;
          padding: 25px;
          border-radius: 16px;
        "
      >
        <div
          class="row"
          style="
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
          "
        >
          <div>
            <label
              style="
                font-weight: 700;
                color: #475569;
                display: block;
                margin-bottom: 8px;
              "
              >訂單流程狀態</label
            >
            <select
              id="m-status"
              class="form-control"
              style="font-weight: 800; border-radius: 10px"
            >
              <option value="AWAITING_REVIEW">待審核</option>
              <option value="PENDING_PAYMENT">待付款</option>
              <option value="PROCESSING">已收款(處理中)</option>
              <option value="SHIPPED">已裝櫃發貨</option>
              <option value="CUSTOMS_CHECK">海關查驗中</option>
              <option value="UNSTUFFING">拆櫃派送中</option>
              <option value="COMPLETED">已完成</option>
              <option value="RETURNED">訂單退回</option>
              <option value="CANCELLED">已取消</option>
            </select>
          </div>
          <div>
            <label
              style="
                font-weight: 700;
                color: #475569;
                display: block;
                margin-bottom: 8px;
              "
              >手動修改總額 (NT$)</label
            >
            <input
              type="number"
              id="m-cost"
              class="form-control"
              style="border-radius: 10px; font-weight: 700"
            />
          </div>
          <div>
            <label
              style="
                font-weight: 700;
                color: #475569;
                display: block;
                margin-bottom: 8px;
              "
              >台灣端單號 (TW Tracking)</label
            >
            <input
              type="text"
              id="m-tracking-tw"
              class="form-control"
              style="border-radius: 10px; font-family: monospace"
              placeholder="黑貓/新竹單號"
            />
          </div>
        </div>
        <div
          class="row mt-3"
          style="
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 20px;
            margin-top: 20px;
          "
        >
          <div>
            <label
              style="
                font-weight: 700;
                color: #475569;
                display: block;
                margin-bottom: 8px;
              "
              ><i class="fas fa-calendar-alt"></i> 預計裝櫃日期</label
            >
            <input
              type="date"
              id="m-loading-date"
              class="form-control"
              style="border-radius: 10px"
            />
          </div>
          <div>
            <label
              style="
                font-weight: 700;
                color: #475569;
                display: block;
                margin-bottom: 8px;
              "
              >客戶可見備註 (顯示於前台詳情)</label
            >
            <input
              type="text"
              id="m-note"
              class="form-control"
              style="border-radius: 10px"
            />
          </div>
        </div>
      </div>

      <div
        class="modal-footer d-flex justify-content-between p-0 border-0"
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-top: 2px solid #f1f5f9;
          padding-top: 20px;
        "
      >
        <button
          type="button"
          id="btn-return-shipment"
          class="btn btn-outline-danger"
          style="
            background: transparent;
            border: 1.5px solid #ef4444;
            color: #ef4444;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
          "
        >
          <i class="fas fa-undo"></i> 退回訂單並釋放包裹
        </button>
        <div class="btn-group" style="display: flex; gap: 12px">
          <button
            type="button"
            class="btn btn-secondary px-4"
            onclick="window.printShipment()"
            style="
              background: #64748b;
              color: white;
              border: none;
              padding: 10px 25px;
              border-radius: 10px;
              font-weight: 700;
              cursor: pointer;
            "
          >
            <i class="fas fa-print"></i> 列印單據
          </button>
          <button
            type="submit"
            class="btn btn-success px-5"
            style="
              background: #22c55e;
              color: white;
              border: none;
              padding: 10px 40px;
              border-radius: 10px;
              font-weight: 800;
              cursor: pointer;
              box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
            "
          >
            <i class="fas fa-save"></i> 儲存所有變更
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<style>
  /* 深度還原：包裹細節表格專用樣式 */
  .package-detail-table th,
  .package-detail-table td {
    border: 1px solid #f1f5f9;
    font-size: 13px;
  }
  .pkg-thumb {
    width: 45px;
    height: 45px;
    object-fit: cover;
    border-radius: 6px;
    cursor: zoom-in;
    border: 1px solid #e2e8f0;
  }

  /* 表單控制項微調 */
  .form-control:focus {
    border-color: #1a73e8;
    outline: none;
    box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
  }
</style>

<script>
  /**
   * 深度還原：管理端核心操作邏輯
   * 對接 admin.api.js 中的訂單更新與退回邏輯
   */
  document
    .getElementById("edit-shipment-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();
      if (window.adminShipmentModule) {
        await window.adminShipmentModule.updateShipmentDetails();
      }
    });

  document
    .getElementById("btn-return-shipment")
    .addEventListener("click", async function () {
      if (
        confirm(
          "確定要退回此訂單嗎？退回後訂單將被取消，且內部包裹將變回「在倉」狀態。"
        )
      ) {
        if (window.adminShipmentModule) {
          await window.adminShipmentModule.returnShipment();
        }
      }
    });
</script>
