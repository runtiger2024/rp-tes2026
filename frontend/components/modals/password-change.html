<div id="change-password-modal" class="modal-overlay" style="display: none">
  <div
    class="modal-content animate-pop-in"
    style="max-width: 450px; width: 90%"
  >
    <button class="modal-close" onclick="window.modalManager.close()">
      &times;
    </button>

    <div
      class="modal-header"
      style="
        border-bottom: 1.5px solid #f1f5f9;
        padding-bottom: 15px;
        margin-bottom: 20px;
      "
    >
      <h3
        style="
          margin: 0;
          color: #1e293b;
          font-weight: 800;
          display: flex;
          align-items: center;
        "
      >
        <i
          class="fas fa-user-lock"
          style="color: #d32f2f; margin-right: 12px; font-size: 20px"
        ></i
        >修改登入密碼
      </h3>
    </div>

    <form id="change-password-form">
      <input
        type="text"
        name="username"
        id="cp-username-hidden"
        style="display: none"
        autocomplete="username"
      />

      <div class="form-group" style="margin-bottom: 15px">
        <label
          class="required"
          style="
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #334155;
          "
          >目前密碼</label
        >
        <div style="position: relative">
          <input
            type="password"
            id="cp-current"
            class="form-control"
            required
            autocomplete="current-password"
            placeholder="請輸入舊密碼驗證身份"
            style="
              width: 100%;
              padding: 12px;
              border: 1.5px solid #e2e8f0;
              border-radius: 12px;
            "
          />
        </div>
      </div>

      <div
        style="
          background: #fff5f5;
          padding: 15px;
          border-radius: 12px;
          border: 1px solid #fee2e2;
          margin-bottom: 20px;
        "
      >
        <div class="form-group" style="margin-bottom: 15px">
          <label
            class="required"
            style="
              display: block;
              margin-bottom: 8px;
              font-weight: 600;
              color: #991b1b;
            "
            >設定新密碼</label
          >
          <input
            type="password"
            id="cp-new"
            class="form-control"
            minlength="6"
            required
            autocomplete="new-password"
            placeholder="至少 6 位數強大密碼"
            style="
              width: 100%;
              padding: 12px;
              border: 1.5px solid #fca5a5;
              border-radius: 12px;
            "
          />
        </div>

        <div class="form-group">
          <label
            class="required"
            style="
              display: block;
              margin-bottom: 8px;
              font-weight: 600;
              color: #991b1b;
            "
            >再次確認新密碼</label
          >
          <input
            type="password"
            id="cp-confirm"
            class="form-control"
            minlength="6"
            required
            autocomplete="new-password"
            placeholder="再次輸入以確保一致"
            style="
              width: 100%;
              padding: 12px;
              border: 1.5px solid #fca5a5;
              border-radius: 12px;
            "
          />
        </div>
      </div>

      <div
        class="modal-footer"
        style="display: flex; gap: 10px; margin-top: 25px"
      >
        <button
          type="button"
          class="btn btn-secondary"
          onclick="window.modalManager.close()"
          style="
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            background: #fff;
            border: 1px solid #e2e8f0;
            color: #64748b;
          "
        >
          取消
        </button>
        <button
          type="submit"
          class="btn btn-primary"
          style="
            flex: 2;
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            background: #d32f2f;
            color: #fff;
            border: none;
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.2);
          "
        >
          確認修改密碼
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  /**
   * 深度還原：客戶端密碼一致性即時驗證
   */
  const cpNew = document.getElementById("cp-new");
  const cpConfirm = document.getElementById("cp-confirm");
  const cpForm = document.getElementById("change-password-form");

  function validatePasswords() {
    if (cpNew.value !== cpConfirm.value) {
      cpConfirm.setCustomValidity("兩次輸入的新密碼不一致");
    } else {
      cpConfirm.setCustomValidity("");
    }
  }

  cpNew.addEventListener("change", validatePasswords);
  cpConfirm.addEventListener("keyup", validatePasswords);

  /**
   * 深度還原：表單提交邏輯
   * 對接核心 auth.js 或 userStore 模組
   */
  cpForm.addEventListener("submit", async function (e) {
    e.preventDefault();
    const currentPassword = document.getElementById("cp-current").value;
    const newPassword = cpNew.value;

    // 呼叫模組 API 修改密碼
    if (window.authModule && window.authModule.updatePassword) {
      await window.authModule.updatePassword(currentPassword, newPassword);
    } else {
      console.warn("Auth module not ready");
    }
  });
</script>
