<div id="deposit-modal" class="modal-overlay" style="display: none">
  <div class="modal-content animate-pop-in">
    <button class="modal-close" onclick="window.modalManager.close()">
      &times;
    </button>

    <div class="modal-header">
      <h3 style="margin: 0; color: #1e293b; font-weight: 800">
        <i class="fas fa-wallet" style="color: #1a73e8; margin-right: 10px"></i
        >申請錢包儲值
      </h3>
    </div>

    <div class="modal-body">
      <div
        id="deposit-bank-info"
        style="
          background: #f8fafc;
          padding: 15px;
          border-radius: 10px;
          border: 1px solid #e2e8f0;
          margin-bottom: 20px;
          font-size: 14px;
          color: #475569;
        "
      >
        <i class="fas fa-info-circle" style="color: #1a73e8"></i>
        載入官方匯款帳號中...
      </div>

      <form id="deposit-form">
        <div class="form-group" style="margin-bottom: 15px">
          <label
            class="required"
            style="
              display: block;
              margin-bottom: 8px;
              font-weight: 600;
              color: #334155;
            "
            >儲值金額 (TWD)</label
          >
          <input
            type="number"
            id="dep-amount"
            class="form-control"
            placeholder="請輸入欲儲值的金額"
            min="100"
            required
            style="
              width: 100%;
              padding: 12px;
              border: 1.5px solid #e2e8f0;
              border-radius: 10px;
              font-size: 15px;
            "
          />
        </div>

        <div
          class="b2b-invoice-card"
          style="
            background: #f0f9ff;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e0f2fe;
            margin-bottom: 15px;
          "
        >
          <label
            style="
              display: block;
              margin-bottom: 8px;
              font-weight: 600;
              color: #0369a1;
              font-size: 13px;
            "
          >
            <i class="fas fa-file-invoice"></i> 公司發票資訊 (B2B 請填寫)
          </label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px">
            <input
              type="text"
              id="dep-taxId"
              class="form-control"
              placeholder="統一編號"
              style="
                padding: 10px;
                border: 1px solid #bae6fd;
                border-radius: 8px;
                font-size: 14px;
              "
            />
            <input
              type="text"
              id="dep-invoiceTitle"
              class="form-control"
              placeholder="公司抬頭"
              style="
                padding: 10px;
                border: 1px solid #bae6fd;
                border-radius: 8px;
                font-size: 14px;
              "
            />
          </div>
        </div>

        <div class="form-group" style="margin-bottom: 15px">
          <label
            style="
              display: block;
              margin-bottom: 8px;
              font-weight: 600;
              color: #334155;
            "
            >轉帳末五碼 / 備註</label
          >
          <input
            type="text"
            id="dep-note"
            class="form-control"
            placeholder="例: 末五碼 12345"
            style="
              width: 100%;
              padding: 12px;
              border: 1.5px solid #e2e8f0;
              border-radius: 10px;
            "
          />
        </div>

        <div class="form-group">
          <label
            class="required"
            style="
              display: block;
              margin-bottom: 8px;
              font-weight: 600;
              color: #334155;
            "
            >轉帳憑證截圖</label
          >
          <div class="upload-zone-wrapper">
            <label
              id="dep-upload-label"
              for="dep-proof"
              class="deposit-upload-zone"
              style="
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 150px;
                border: 2px dashed #cbd5e1;
                border-radius: 12px;
                cursor: pointer;
                background: #f8fafc;
              "
            >
              <i
                class="fas fa-cloud-upload-alt"
                style="font-size: 30px; color: #94a3b8; margin-bottom: 10px"
              ></i>
              <span style="color: #64748b; font-size: 14px"
                >點擊或拖放照片至此</span
              >
            </label>

            <div
              id="dep-preview-wrapper"
              style="display: none; margin-top: 10px; text-align: center"
            >
              <img
                id="dep-preview-img"
                src=""
                style="
                  max-width: 100%;
                  max-height: 250px;
                  border-radius: 8px;
                  border: 1px solid #ddd;
                  display: block;
                  margin: 0 auto 10px;
                "
              />
              <button
                type="button"
                id="btn-reset-proof"
                style="
                  background: #ef4444;
                  color: white;
                  border: none;
                  padding: 8px 20px;
                  border-radius: 8px;
                  cursor: pointer;
                  font-size: 13px;
                  font-weight: 600;
                  transition: background 0.2s;
                "
              >
                <i class="fas fa-redo"></i> 重新上傳
              </button>
            </div>

            <input
              type="file"
              id="dep-proof"
              accept="image/*"
              style="display: none"
              required
            />
          </div>
        </div>

        <button
          type="submit"
          class="btn btn-primary"
          style="
            width: 100%;
            padding: 14px;
            background: #1a73e8;
            color: #fff;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            margin-top: 25px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.2);
          "
        >
          確認提交儲值申請
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  /**
   * 深度還原：圖片預覽與重設邏輯
   */
  const depFileInput = document.getElementById("dep-proof");
  const depPreviewWrapper = document.getElementById("dep-preview-wrapper");
  const depUploadLabel = document.getElementById("dep-upload-label");
  const depPreviewImg = document.getElementById("dep-preview-img");
  const btnResetProof = document.getElementById("btn-reset-proof");

  depFileInput.addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (event) {
        depPreviewImg.src = event.target.result;
        depPreviewWrapper.style.display = "block";
        depUploadLabel.style.display = "none";
      };
      reader.readAsDataURL(file);
    }
  });

  btnResetProof.addEventListener("click", function () {
    depFileInput.value = "";
    depPreviewImg.src = "";
    depPreviewWrapper.style.display = "none";
    depUploadLabel.style.display = "flex";
  });

  /**
   * 深度還原：表單提交對接
   */
  document
    .getElementById("deposit-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();
      const amount = document.getElementById("dep-amount").value;
      const taxId = document.getElementById("dep-taxId").value;
      const invoiceTitle = document.getElementById("dep-invoiceTitle").value;
      const note = document.getElementById("dep-note").value;
      const proofFile = depFileInput.files[0];

      // 呼叫 wallet.js 模組處理儲值申請
      if (window.walletModule && window.walletModule.submitDepositRequest) {
        await window.walletModule.submitDepositRequest({
          amount,
          taxId,
          invoiceTitle,
          note,
          proofFile,
        });
      }
    });
</script>
