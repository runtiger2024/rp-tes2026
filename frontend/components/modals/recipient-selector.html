<div id="recipient-selector-modal" class="modal-overlay" style="display: none">
  <div
    class="modal-content animate-zoom-in"
    style="max-width: 500px; width: 95%; border-radius: 20px; overflow: hidden"
  >
    <div
      class="modal-header"
      style="padding: 20px 25px; border-bottom: 1px solid #f1f5f9"
    >
      <h3
        style="
          margin: 0;
          font-weight: 800;
          color: #1e293b;
          display: flex;
          align-items: center;
        "
      >
        <i
          class="fas fa-address-book"
          style="color: #1a73e8; margin-right: 12px; font-size: 20px"
        ></i
        >選擇常用收件人
      </h3>
      <button
        class="modal-close"
        onclick="document.getElementById('recipient-selector-modal').style.display='none'"
        style="
          background: none;
          border: none;
          font-size: 24px;
          color: #94a3b8;
          cursor: pointer;
        "
      >
        &times;
      </button>
    </div>

    <div class="modal-body" style="padding: 25px">
      <div class="search-input-group-wrapper" style="margin-bottom: 20px">
        <div
          class="search-input-group"
          style="position: relative; display: flex; align-items: center"
        >
          <i
            class="fas fa-search"
            style="position: absolute; left: 15px; color: #94a3b8"
          ></i>
          <input
            type="text"
            id="recipient-selector-search"
            class="form-control"
            placeholder="輸入收件人姓名或電話快速過濾..."
            autocomplete="off"
            style="
              padding: 12px 12px 12px 40px;
              border-radius: 12px;
              border: 1.5px solid #e2e8f0;
              width: 100%;
              font-size: 15px;
              transition: all 0.2s;
            "
          />
        </div>
        <div
          style="
            font-size: 12px;
            color: #64748b;
            margin-top: 10px;
            padding-left: 5px;
          "
        >
          <i class="fas fa-info-circle" style="color: #1a73e8"></i>
          點擊下方項目即可自動帶入集運單資料
        </div>
      </div>

      <div
        id="recipient-selector-list"
        class="recipient-selector-list custom-scrollbar"
        style="
          max-height: 400px;
          overflow-y: auto;
          padding: 2px;
          display: flex;
          flex-direction: column;
          gap: 12px;
        "
      >
        <div style="text-align: center; padding: 40px; color: #94a3b8">
          <i class="fas fa-spinner fa-spin fa-2x"></i>
          <p style="margin-top: 12px; font-weight: 600">
            正在載入常用收件人...
          </p>
        </div>
      </div>
    </div>

    <div
      class="modal-footer"
      style="
        padding: 20px 25px;
        border-top: 1px solid #f1f5f9;
        background: #f8fafc;
        display: flex;
        gap: 12px;
      "
    >
      <button
        class="btn btn-secondary"
        onclick="document.getElementById('recipient-selector-modal').style.display='none'"
        style="
          flex: 1;
          padding: 12px;
          border-radius: 12px;
          border: 1px solid #e2e8f0;
          background: #fff;
          color: #64748b;
          font-weight: 700;
          cursor: pointer;
        "
      >
        取消返回
      </button>
      <button
        class="btn btn-primary-light"
        onclick="handleManageRecipients()"
        style="
          flex: 1.5;
          padding: 12px;
          border-radius: 12px;
          background: #eff6ff;
          color: #1a73e8;
          border: none;
          font-weight: 700;
          cursor: pointer;
          transition: all 0.2s;
        "
        onmouseover="this.style.background='#dbeafe'"
        onmouseout="this.style.background='#eff6ff'"
      >
        <i class="fas fa-plus"></i> 管理收件人
      </button>
    </div>
  </div>
</div>

<style>
  /* 深度還原：彈窗基礎動畫 */
  .animate-zoom-in {
    animation: modalZoomIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  @keyframes modalZoomIn {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  /* 深度還原：列表項目樣式優化 */
  .recipient-selector-item {
    padding: 16px;
    border: 1px solid #e2e8f0;
    border-radius: 14px;
    cursor: pointer;
    background: #fff;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }
  .recipient-selector-item:hover {
    background: #f8fafc;
    border-color: #1a73e8;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }
  .recipient-selector-item .badge-default-tiny {
    background: #eef2ff;
    color: #4f46e5;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 50px;
    font-weight: 700;
    margin-right: 8px;
  }

  /* 深度還原：自定義美化捲軸 */
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 10px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
</style>

<script>
  /**
   * 深度還原：管理收件人導航邏輯
   * 此函數會處理多層彈窗的關閉並導引至正確分頁
   */
  function handleManageRecipients() {
    // 關閉目前選擇器
    document.getElementById("recipient-selector-modal").style.display = "none";

    // 若是從集運頁面開啟的，一併關閉集運彈窗
    const shipmentModal = document.getElementById("create-shipment-modal");
    if (shipmentModal) shipmentModal.style.display = "none";

    // 模擬點擊側邊欄或標籤切換至「收件人管理」分頁
    const recipientTab = document.getElementById("tab-recipients");
    if (recipientTab) {
      recipientTab.click();
    } else {
      // 備用方案：若 ID 不存在則執行全域導航
      if (window.layoutEngine) window.layoutEngine.switchTab("recipients");
    }
  }

  /**
   * 深度還原：即時搜尋過濾邏輯
   */
  document
    .getElementById("recipient-selector-search")
    .addEventListener("input", function (e) {
      const term = e.target.value.toLowerCase();
      const items = document.querySelectorAll(".recipient-selector-item");
      items.forEach((item) => {
        const text = item.innerText.toLowerCase();
        item.style.display = text.includes(term) ? "block" : "none";
      });
    });
</script>
