<div id="profile-edit-modal" class="modal-overlay" style="display: none">
  <div class="modal-content profile-modal-v2 animate-pop-in">
    <button class="modal-close" onclick="window.modalManager.close()">
      &times;
    </button>

    <div
      class="profile-modal-header"
      style="
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        padding: 30px;
        border-radius: 20px 20px 0 0;
        border-bottom: 1px solid #e2e8f0;
      "
    >
      <div
        class="user-avatar-section"
        style="display: flex; align-items: center; gap: 20px"
      >
        <div
          class="avatar-big"
          style="
            width: 70px;
            height: 70px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 2px solid #fff;
          "
        >
          <i
            class="fas fa-user-shield"
            style="font-size: 30px; color: #1a73e8"
          ></i>
        </div>
        <div class="user-main-info">
          <h3
            id="modal-user-name"
            style="margin: 0; font-weight: 800; color: #1e293b"
          >
            載入中...
          </h3>
          <span
            class="member-badge"
            style="
              background: #fef3c7;
              color: #92400e;
              padding: 4px 12px;
              border-radius: 20px;
              font-size: 12px;
              font-weight: 700;
              margin-top: 5px;
              display: inline-block;
            "
          >
            <i class="fas fa-crown"></i> 一般會員
          </span>
        </div>
      </div>
      <div
        class="user-id-card"
        style="
          margin-top: 20px;
          background: #fff;
          padding: 12px 20px;
          border-radius: 12px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border: 1px solid #e2e8f0;
        "
      >
        <label style="font-size: 13px; color: #64748b; font-weight: 600"
          >我的會員編號 (Piggy ID)</label
        >
        <div
          class="id-value"
          style="
            font-family: 'Monaco', monospace;
            font-weight: 800;
            color: #1a73e8;
            font-size: 16px;
          "
        >
          <span id="modal-user-id">---</span>
        </div>
      </div>
    </div>

    <form id="profile-edit-form" style="display: contents">
      <div
        class="profile-modal-body"
        style="padding: 25px; display: flex; flex-direction: column; gap: 20px"
      >
        <div
          class="modal-section-card"
          style="
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
          "
        >
          <div
            class="modal-section-title"
            style="
              font-size: 15px;
              font-weight: 800;
              color: #1e293b;
              margin-bottom: 15px;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <i class="fas fa-id-card" style="color: #64748b"></i> 基本聯絡資訊
          </div>
          <div
            class="form-row-2"
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px"
          >
            <div class="form-group">
              <label
                class="required"
                style="
                  display: block;
                  margin-bottom: 8px;
                  font-size: 13px;
                  font-weight: 600;
                  color: #475569;
                "
                >真實姓名</label
              >
              <input
                type="text"
                id="edit-name"
                class="form-control"
                placeholder="請輸入姓名"
                required
                style="
                  width: 100%;
                  padding: 12px;
                  border: 1.5px solid #e2e8f0;
                  border-radius: 10px;
                "
              />
            </div>
            <div class="form-group">
              <label
                class="required"
                style="
                  display: block;
                  margin-bottom: 8px;
                  font-size: 13px;
                  font-weight: 600;
                  color: #475569;
                "
                >聯絡電話</label
              >
              <input
                type="tel"
                id="edit-phone"
                class="form-control"
                placeholder="請輸入手機"
                required
                style="
                  width: 100%;
                  padding: 12px;
                  border: 1.5px solid #e2e8f0;
                  border-radius: 10px;
                "
              />
            </div>
          </div>
        </div>

        <div
          class="modal-section-card"
          style="
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
          "
        >
          <div
            class="modal-section-title"
            style="
              font-size: 15px;
              font-weight: 800;
              color: #1e293b;
              margin-bottom: 15px;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <i class="fas fa-file-invoice" style="color: #64748b"></i>
            電子發票資訊 (選填)
          </div>
          <div
            class="form-row-2"
            style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px"
          >
            <div class="form-group">
              <label
                style="
                  display: block;
                  margin-bottom: 8px;
                  font-size: 13px;
                  font-weight: 600;
                  color: #475569;
                "
                >統一編號</label
              >
              <input
                type="text"
                id="edit-taxId"
                class="form-control"
                placeholder="8位數字"
                maxlength="8"
                style="
                  width: 100%;
                  padding: 12px;
                  border: 1.5px solid #e2e8f0;
                  border-radius: 10px;
                "
              />
            </div>
            <div class="form-group">
              <label
                style="
                  display: block;
                  margin-bottom: 8px;
                  font-size: 13px;
                  font-weight: 600;
                  color: #475569;
                "
                >發票抬頭</label
              >
              <input
                type="text"
                id="edit-invoiceTitle"
                class="form-control"
                placeholder="公司全名"
                style="
                  width: 100%;
                  padding: 12px;
                  border: 1.5px solid #e2e8f0;
                  border-radius: 10px;
                "
              />
            </div>
          </div>
        </div>

        <div
          class="modal-section-card"
          style="
            border: 1px dashed #cbd5e1;
            background: #f8fafc;
            border-radius: 16px;
            padding: 15px 20px;
          "
        >
          <div
            class="modal-section-title"
            style="
              font-size: 14px;
              font-weight: 700;
              color: #1e293b;
              margin-bottom: 10px;
              display: flex;
              align-items: center;
              gap: 8px;
            "
          >
            <i class="fas fa-user-lock" style="color: #64748b"></i> 帳號安全
          </div>
          <div
            class="security-action-box"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <span style="font-size: 13px; color: #64748b"
              >定期更改密碼保護帳戶安全</span
            >
            <button
              type="button"
              class="btn-text-action"
              onclick="window.modalManager.open('password-change')"
              style="
                background: #fff;
                border: 1px solid #e2e8f0;
                padding: 6px 15px;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 700;
                color: #1a73e8;
                cursor: pointer;
              "
            >
              修改密碼
            </button>
          </div>
        </div>
      </div>

      <div
        class="modal-footer-actions"
        style="padding: 0 25px 25px; display: flex; gap: 15px"
      >
        <button
          type="button"
          class="btn btn-secondary"
          style="
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            background: #fff;
            color: #64748b;
            font-weight: 700;
          "
          onclick="window.modalManager.close()"
        >
          取消
        </button>
        <button
          type="submit"
          class="btn btn-primary btn-save"
          style="
            flex: 2;
            padding: 12px;
            border-radius: 12px;
            background: #1a73e8;
            color: #fff;
            border: none;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.2);
          "
        >
          <i class="fas fa-save" style="margin-right: 8px"></i> 儲存所有變更
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  /**
   * 深度還原：表單提交對接邏輯
   * 此處會將數據傳送到 userStore 進行更新
   */
  document
    .getElementById("profile-edit-form")
    .addEventListener("submit", async function (e) {
      e.preventDefault();
      const data = {
        name: document.getElementById("edit-name").value,
        phone: document.getElementById("edit-phone").value,
        taxId: document.getElementById("edit-taxId").value,
        invoiceTitle: document.getElementById("edit-invoiceTitle").value,
      };

      if (window.userStore && window.userStore.updateUserProfile) {
        await window.userStore.updateUserProfile(data);
      }
    });
</script>
